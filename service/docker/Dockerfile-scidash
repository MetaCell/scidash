FROM python:3.6

USER root

# BUILD VARIABLES
ARG EMAIL_USERNAME
ARG EMAIL_PASSWORD
ARG ROOT=/
ARG APP_DIR=/app
ARG NRN_SYMLINK=/Applications/NEURON-7.6/nrn/
ARG DOTENV_FILE=env-docker
ARG STATIC_DIR=$APP_DIR/scidash/static
ARG GEPPETTO_DIR=$STATIC_DIR/org.geppetto.frontend/src/main/webapp
ARG targetBranch=geppetto-scidash
ARG originBranch=geppetto-scidash
ARG defaultBranch=geppetto-scidash

ENV SERVER_HOME $APP_DIR/virgo-tomcat-server

RUN useradd -ms /bin/bash developer
ENV HOME /home/developer

WORKDIR $ROOT

# INSTALLING REQUIREMENTS
RUN apt-get update
RUN apt-get install -y gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 \
    libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 \
    libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 \
    libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 \
    libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 \
    lsb-release xdg-utils wget curl llvm python3-tk 
RUN curl -sL https://deb.nodesource.com/setup_10.x | bash
RUN apt-get update && apt-get -y install nodejs
RUN curl https://www.npmjs.com/install.sh | sh
RUN pip install virtualenv
RUN mkdir $APP_DIR
RUN chown developer $APP_DIR
RUN chown -R developer /home/developer/.config
RUN git clone https://github.com/ddelpiano/travis_utils
RUN cp travis_utils/copy.sh $APP_DIR

USER developer

# COPYING PROJECT
WORKDIR $APP_DIR
# set git email and name for use with git merge
RUN git config --global user.email "scidash@metacell.us"
RUN git config --global user.name "SciDash"
RUN $APP_DIR/copy.sh https://github.com/Metacell/scidash.git "${targetBranch}" "${originBranch}" "${defaultBranch}"


WORKDIR $APP_DIR/scidash
RUN virtualenv venv-py -p python3.6

WORKDIR $APP_DIR/scidash
RUN make ARGS="-b $targetBranch" install-backend-with-env
RUN make ARGS="-b $targetBranch" install-frontend

RUN sed -i "s/email_username/$EMAIL_USERNAME/g" ./scidash/main/settings.py
RUN sed -i "s/email_password/$EMAIL_PASSWORD/g" ./scidash/main/settings.py

WORKDIR $GEPPETTO_DIR
RUN ls -la
RUN npm run build-dev-noTest

WORKDIR $APP_DIR/scidash
RUN cp ./service/dotenv/scidash_env .env

USER root
RUN echo 'kernel.unprivileged_userns_clone=1' > /etc/sysctl.d/userns.conf

USER developer
CMD ./service/scripts/run.sh
