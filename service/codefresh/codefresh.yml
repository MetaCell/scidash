version: '1.0'
steps:
  InstallFrontend:
    image: node:8
    working_directory: ${{main_clone}}
    commands:
      - make install-frontend
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: metacell/scidash
    working_directory: ./
    tag: ${{CF_BRANCH}}-${{CF_BUILD_ID}}
    no_cache: true
    dockerfile: ./service/docker/Dockerfile-scidash
  PushingToDockerRegistry:
    title: Pushing to Docker Registry
    type: push
    candidate: '${{BuildingDockerImage}}'
    tag: ${{CF_BRANCH}}-${{CF_BUILD_ID}}
    registry: cfcr
  Deploy:
    image: codefresh/kube-helm:master
    environment:
      - IMAGE=${{BuildingDockerImage}}
    commands:
      - gcloud container clusters get-credentials geppetto-cluster --zone us-central1-a --project metacellllc
      - kubectl set image deployment/scidash scidash=$IMAGE --namespace=scidash-testing
